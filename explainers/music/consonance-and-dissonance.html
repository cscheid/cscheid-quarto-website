<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-06-13">

<title>cscheid-quarto-website - Consonance and Dissonance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script type="module" src="../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Consonance and Dissonance</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 13, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>I recently learned that there’s now a really good theory for why some musical intervals sound consonant (“nice”), and some sound dissonant (“rough”, “out of tune”). This theory explains a lot of music, is backed by good experiments, is simple enough to explain in a single article, and was only figured out about 60 years ago.</p>
<p>Incredibly, this theory <em>also</em> explains both why Pythagoras thought music had to do with simple fractions, why western music likes 12-tone scales so much, and why <em>other</em> musical cultures choose other scales!</p>
<p>I’m talking about Plomp-Levelt curves <span class="citation" data-cites="plomp1965tonal">(<a href="#ref-plomp1965tonal" role="doc-biblioref">Plomp and Levelt 1965</a>)</span>.</p>
<section id="on-terminology" class="level2">
<h2 class="anchored" data-anchor-id="on-terminology">On terminology</h2>
<p>In this article I’m using <strong>consonance</strong> to mean the perceptual notion: does this particular sound feel “smooth” or “rough”? Other definitions are also useful <span class="citation" data-cites="sethares2005tuning">(see <a href="#ref-sethares2005tuning" role="doc-biblioref">Sethares 2005, chap. 3</a>)</span>, especially for writing music within a particular culture! But I’m interested in the “perceptual” notion because, for example, it will eventually let us say interesting things about the other notions.</p>
</section>
<section id="consonance-and-dissonance-in-pure-sounds" class="level2">
<h2 class="anchored" data-anchor-id="consonance-and-dissonance-in-pure-sounds">Consonance and dissonance in “pure” sounds</h2>
<p>In math, there’s a famous way to decompose (or “analyze”, in signal-processingese) complicated sounds into simple sounds: that’s “Fourier analysis”. Sounds are waves, and you can think of complicated sounds as a sum of simple waves. Then, if we understand what happens with simple sounds, we use this understanding as a building block to understand what happens with complex sounds.</p>
<p>The simplest wave is a sine curve with a given frequency and phase. But: is this math relevant to our how we <em>hear</em> sounds?</p>
<p>It’s an incredible biological fact about your ears that yes, ears do Fourier analysis! Specifically, your ear has a part called a <em>basilar membrane</em>, and it decomposes a sound into frequencies. Specifically, the basilar membrane makes it so different frequencies are sent to different positions in your cochlea.</p>
<section id="critical-bandwidth" class="level3">
<h3 class="anchored" data-anchor-id="critical-bandwidth">Critical bandwidth</h3>
<p>However, the basilar membrane is not perfect, and nearby frequencies bleed into one another. For each position in the cochlea, there is a range of nearby frequencies that activate it: some more strongly, some less so. The “size” of this region is called the “critical bandwidth”, and it looks like this:</p>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb1" data-startfrom="32" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 31;"><span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="fu">sizedPlot</span>({</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">x</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Frequency"</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [<span class="dv">100</span><span class="op">,</span> <span class="dv">10000</span>] }<span class="op">,</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Critical Bandwidth"</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [<span class="dv">50</span><span class="op">,</span> <span class="dv">1000</span>] }<span class="op">,</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [ Plot<span class="op">.</span><span class="fu">line</span>(crit<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span>})<span class="op">,</span> </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>         <span class="co">// Plot.line(wholeTone, {x: "x", y: "y"}) </span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>         ]</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-1" data-nodetype="expression">

</div>
</div>
</div>
<p>Here’s how you read this plot. The part of the cochlea that receives 100 Hz (Hz, “Hertz” is the frequency of “one per second”. The higher the number, the faster the wave vibrates) also is activated by frequencies from 50 Hz to 150 Hz (100Hz is the “width” of the “band” it perceives, the “bandwidth”). At 1KHz, the bandwidth is closer to 150Hz, and at 3KHz and higher, it becomes around 12% of the base frequency.</p>
</section>
</section>
<section id="measuring-consonance-and-dissonance-of-simple-waves" class="level2">
<h2 class="anchored" data-anchor-id="measuring-consonance-and-dissonance-of-simple-waves">Measuring consonance and dissonance of simple waves</h2>
<p>The breakthrough experiment that Plomp and Levelt did in 1965 was to ask people, in a controlled environment, whether pairs of sine waves sounded consonant or dissonant. They tried a number of different base frequencies and intervals (differences between the frequencies). They found that sine waves that are very close to one another sound consonant. So do sound waves that are very apart from one another. But two sine waves that are <em>kind of close</em> to each other sound rough. And this distance tends to match the critical bandwidth along the basilar membrane! So, for pure sine waves, the curve looks like this.</p>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb2" data-startfrom="49" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 48;"><span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="fu">sizedPlot</span>({</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Fraction of critical bandwidth →"</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"↑ Dissonance"</span><span class="op">,</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">line</span>(diss<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span>})<span class="op">,</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="expression">

</div>
</div>
</div>
<p>A different way to think about this is to consider a two-dimensional plot of frequencies against frequencies, where color indicates whether a pair of sine waves will sound rough or in-tune:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" data-startfrom="68" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 67;"><span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> w <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> h <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> steps <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> minFreq <span class="op">=</span> <span class="dv">100</span><span class="op">,</span> maxFreq <span class="op">=</span> <span class="dv">800</span><span class="op">;</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> context <span class="op">=</span> DOM<span class="op">.</span><span class="fu">context2d</span>(w<span class="op">,</span> h)<span class="op">;</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">// I'm sure there's a better way to do this.</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> freq <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">range</span>([<span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>(minFreq)<span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>(maxFreq)])<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> steps])<span class="op">;</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> steps])<span class="op">.</span><span class="fu">range</span>([<span class="dv">40</span><span class="op">,</span> <span class="dv">360</span>])<span class="op">;</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> steps])<span class="op">.</span><span class="fu">range</span>([<span class="dv">370</span><span class="op">,</span> <span class="dv">30</span>])<span class="op">;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([<span class="st">"white"</span><span class="op">,</span> <span class="st">"red"</span>])<span class="op">;</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> xi <span class="kw">of</span> d3<span class="op">.</span><span class="fu">range</span>(steps)) {</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> yi <span class="kw">of</span> d3<span class="op">.</span><span class="fu">range</span>(steps)) {</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">debugger</span><span class="op">;</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> xf <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(<span class="fu">freq</span>(xi))<span class="op">;</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> yf <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(<span class="fu">freq</span>(yi))<span class="op">;</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> left <span class="op">=</span> <span class="fu">x</span>(xi)<span class="op">,</span> top <span class="op">=</span> <span class="fu">y</span>(yi <span class="op">+</span> <span class="dv">1</span>)<span class="op">,</span> right <span class="op">=</span> <span class="fu">x</span>(xi <span class="op">+</span> <span class="dv">1</span>)<span class="op">,</span> bottom <span class="op">=</span> <span class="fu">y</span>(yi)<span class="op">;</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> dis <span class="op">=</span> <span class="fu">totalDissonance</span>([{<span class="dt">tone</span><span class="op">:</span> xf<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}]<span class="op">,</span> [{<span class="dt">tone</span><span class="op">:</span> yf<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}])<span class="op">;</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="fu">color</span>(dis)<span class="op">;</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span><span class="fu">fillRect</span>(left<span class="op">,</span> top<span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(right <span class="op">-</span> left)<span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(top <span class="op">-</span> bottom))<span class="op">+</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> div <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div position="absolute" width="400" height="400" style="max-height: 400px"&gt;&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="fu">appendChild</span>(context<span class="op">.</span><span class="at">canvas</span>)<span class="op">;</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [minFreq<span class="op">,</span> maxFreq] }<span class="op">,</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [minFreq<span class="op">,</span> maxFreq] }<span class="op">,</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">line</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">440</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> minFreq}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="dv">440</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> maxFreq}]<span class="op">,</span> { <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span> })</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svgStyle <span class="op">=</span> svg<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"svg style"</span>)<span class="op">;</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>  svgStyle<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> svgStyle<span class="op">.</span><span class="at">innerHTML</span><span class="op">.</span><span class="fu">replace</span>(<span class="st">"background: white;"</span><span class="op">,</span> <span class="st">""</span>)<span class="op">;</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">position</span> <span class="op">=</span> <span class="st">"relative"</span><span class="op">;</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">top</span> <span class="op">=</span> <span class="st">"-405px"</span><span class="op">;</span> <span class="co">// 40_5_?! shrug</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="fu">appendChild</span>(svg)<span class="op">;</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> div<span class="op">;</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">// context.canvas;</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>  <span class="co">// return context.canvas;</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="cool-trick.-but-consonance-and-dissonance-are-about-music" class="level2">
<h2 class="anchored" data-anchor-id="cool-trick.-but-consonance-and-dissonance-are-about-music">“Cool trick. But consonance and dissonance are about music!”</h2>
<p>That’s exactly right. And music is made with musical instruments. So we need to understand how sound comes out of musical instruments.</p>
<p>When you pluck a guitar string, you hear a specific pitch. The bottom string in a guitar is often tuned to “E2”, which is associated with the frequency of 82.4Hz. But that’s not the only frequency the guitar string sound contains. Guitar strings are “harmonic”. This means that when the lowest frequency they sound is X, they also make a sound at <em>positive integer multiples</em> of that frequency. They make sounds at 2X the frequency, 3X, 4X, and so on. You’re so used to hearing guitar sounds (and “harmonic instruments” more generally, <em>especially</em> if you were raised in Western Europe or North American musical cultures. More on that later), that you don’t realize this.</p>
<p>The practical consequence is that the sound you thought was simple is actually fairly complicated. But, because we have Fourier analysis as a tool (and because miraculously your ear does Fourier analysis too!) then Fourier analysis can help us decompose complex sounds. So, to study the consonance or dissonance of guitar sounds, we don’t compare one pure wave to another. Instead, we compare the sum of the frequencies made by one string to the sum of the frequencies made by the other. Specifically, we add the sounds of the two strings together. Then, for every pair of resulting frequencies, we compute the dissonance using the formula from the charts above. The “total dissonance” is just the sum of the dissonances for every pair.</p>
<p>Here is the dissonance curve for a simulated guitar sound of E3 (the E you sound with the fourth string of your guitar on the second fret).</p>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb4" data-startfrom="129" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 128;"><span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">842</span><span class="op">,</span> <span class="fu">makeHarmonicTone</span>(<span class="dv">6</span><span class="op">,</span> <span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-4" data-nodetype="expression">

</div>
</div>
</div>
<p>The base frequency for E3 is 842 Hz. If you’re a musician, you’ll notice right away that E4, an octave away at 1684Hz, sounds consonant. That’s really cool, and it’s actually not as obvious as it appears. Although guitars have consonant octaves, other instruments don’t necessarily! If you’re a musician, you might be surprised to know that (for example), pure sine waves a minor ninth away from one another don’t sound dissonant, while they definitely do in the guitar (as you can also see in the chart by looking at 1784Hz).</p>
</section>
<section id="theres-no-consonance-without-timbre" class="level2">
<h2 class="anchored" data-anchor-id="theres-no-consonance-without-timbre">There’s no consonance without timbre</h2>
<p>This is both a simple idea but also very deep: perceptually speaking, whether two notes sound consonant or dissonant depends on the “timbre” of the instrument that played the note.</p>
<p>The “timbre” of an instrument is a hard thing to pin down, but we usually use the word to mean the difference between the sound of a piano’s C4 and a clarinet’s C4. In this simplified setting here, we will use timbre to mean “the set of additional waves produced by an instrument, together with the amplitude of each of those waves”. If you’ve read some of the literature, you might have come across the phrase “overtone series”, a more specific term for this aspect of timbre.</p>
<p>The valleys in the curve above indicate intervals that sound particularly consonant. So if you’re looking to invent a system to play notes that tend to sound nice together, you will naturally end up with something that makes you choose those valleys. For “harmonic instruments” (instruments that produce harmonic overtones), those valleys correspond to many of the notes in the 12-tone scale, specifically under <a href="https://en.wikipedia.org/wiki/Just_intonation">just intonation</a>. So now we have a theory, math, and experiments that show how the design of musical scales is intimately connected to the way in the instruments generate sounds.</p>
</section>
<section id="clarinet-and-other-timbres" class="level2">
<h2 class="anchored" data-anchor-id="clarinet-and-other-timbres">Clarinet, and other timbres</h2>
<p>This theory predicts a number of surprising things. For example, although wind instruments are harmonic, the overtone series of some wind instruments skips many of the harmonics. Specifically, wind instruments with closed tubes have <em>cancelling waves</em> (because the wave bounces back at the end of the tube). As a result, they only emit overtones with <strong>odd</strong> integer multiples of the frequency.</p>
<p>To begin with, this makes them sound different from open-tube wind instruments. A clarinet is a closed-tube wind instrument, and so it sounds markedly different from a saxophone (which is open-tube and has even harmonic overtones). The same applies to the sound difference between flutes (open-tube) and pan flutes (closed-tube).</p>
<p>But in addition to <em>sounding</em> different, clarinets also prefer very different intervals to pianos (that part was personally surprising to me.) Here’s the Plomp-Levelt curves for the clarinet, based on the overtones obtained by <a href="https://pages.mtu.edu/~suits/clarinet.html">Bryan Suits</a>.</p>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb5" data-startfrom="152" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 151;"><span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> clarinetData<span class="op">,</span> <span class="fl">4.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-5" data-nodetype="expression">

</div>
</div>
</div>
<p>In this chart, I’m showing frequencies from 1KHz to 4KHz, so <em>two</em> octaves up. The results here are, if you’ll forgive me, <em>wild</em>. This chart predicts that clarinet intervals sound more consonant at the <em>twelfth</em> note of the traditional western diatonic scale than at the <em>octave itself</em>. There’s other wild features too, such as the absence of an especially dissonant major seventh or ninth! Working from the theory, this all happens because the clarinet lacks the second harmonic (which is an octave up from the base). The second harmonic from the low note, then, is not there to clash with the base frequency of the high ninth note.</p>
<p>I honestly didn’t believe this at first. But then I wrote a simple synthesizer for clarinet sounds:</p>
<ul>
<li><a href="https://cscheid.net/static/synth/piano.mp3">Piano sounds</a>, fifth - <strong>octave</strong> - twelfth - <strong>fifteenth</strong></li>
<li><a href="https://cscheid.net/static/synth/clarinet.mp3">Clarinet sounds</a>, fifth - octave - <strong>twelfth</strong> - fifteenth</li>
</ul>
<p>I marked in bold what, to my ears, are the most consonant intervals in the sequences above. It’s not a subtle effect either!</p>
<p>So, it seems clear to me that a culture that only played closed-tube harmonic instruments could easily end up with weird scales that revolved around twelfth intervals being the “pseudo-octave”. It just sounds better than the octave! That’s bananas.</p>
</section>
<section id="beyond-harmonic-instruments" class="level2">
<h2 class="anchored" data-anchor-id="beyond-harmonic-instruments">Beyond harmonic instruments</h2>
<p>More shockingly, this is only the beginning of this story. We don’t need to come up with imaginary cultures. Non-western cultures play instruments that want different scales, and that’s why they use them!</p>
<p>TBF: Thai xylophones, gamelans</p>
</section>
<section id="appendix-code" class="level1">
<h1>Appendix: code</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" data-startfrom="175" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 174;"><span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>xLog <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">150</span>)<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> x<span class="op">/</span><span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" data-startfrom="179" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 178;"><span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dissonance</span>(critBandwidthFraction)</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> critBandwidthFraction<span class="op">;</span></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> t <span class="op">=</span> <span class="dv">4</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(x)<span class="op">;</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> t <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(<span class="dv">1</span> <span class="op">-</span> t)<span class="op">;</span></span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" data-startfrom="188" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 187;"><span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>wholeTone <span class="op">=</span> xLog<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> ({x<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> x <span class="op">*</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span>)}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" data-startfrom="192" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 191;"><span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>diss <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.01</span>)<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> ({ x<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">dissonance</span>(x) }))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" data-startfrom="196" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 195;"><span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a><span class="co">// empirically reproducing the curve from Figure 3.4 in Sethares's Tuning, Timbre, Spectrum, Scale</span></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">criticalBandwidth</span>(frequency)</span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> frequency<span class="op">;</span></span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> wholeTone <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// assume equal temperament for simplicity</span></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> start <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> xp <span class="op">=</span> x <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ramp <span class="op">=</span> <span class="dv">500</span><span class="op">;</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> start <span class="op">+</span> xp <span class="op">*</span> xp <span class="op">*</span> wholeTone <span class="op">/</span> (xp <span class="op">+</span> ramp)<span class="op">;</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" data-startfrom="210" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 209;"><span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>crit <span class="op">=</span> xLog<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> ({x<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">criticalBandwidth</span>(x)}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-11" data-nodetype="declaration">

</div>
</div>
</div>
</section>
<section id="compound-tones" class="level1">
<h1>Compound Tones</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" data-startfrom="216" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 215;"><span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeCompoundTone</span>(baseFreq<span class="op">,</span> overtones)</span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> overtones<span class="op">.</span><span class="fu">map</span>(({ tone<span class="op">,</span> amplitude }) <span class="kw">=&gt;</span> ({ <span class="dt">tone</span><span class="op">:</span> baseFreq <span class="op">*</span> tone<span class="op">,</span> amplitude }))<span class="op">;</span></span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" data-startfrom="223" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 222;"><span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">totalDissonance</span>(tone1<span class="op">,</span> tone2)</span>
<span id="cb13-224"><a href="#cb13-224" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-225"><a href="#cb13-225" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> result <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> { <span class="dt">tone</span><span class="op">:</span> ot1<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> a1 } <span class="kw">of</span> tone1) {</span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> { <span class="dt">tone</span><span class="op">:</span> ot2<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> a2 } <span class="kw">of</span> tone2) {</span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> low <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(ot1<span class="op">,</span> ot2)<span class="op">,</span> high <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(ot1<span class="op">,</span> ot2)<span class="op">;</span></span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> c <span class="op">=</span> <span class="fu">criticalBandwidth</span>(low)<span class="op">;</span></span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a>      result <span class="op">+=</span> <span class="fu">dissonance</span>((high <span class="op">-</span> low) <span class="op">/</span> (<span class="fl">0.5</span> <span class="op">*</span> c)) <span class="op">*</span> a1 <span class="op">*</span> a2<span class="op">;</span></span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-13" data-nodetype="declaration">

</div>
</div>
</div>
<section id="plomp-levelt-curves-slightly-adapted" class="level2">
<h2 class="anchored" data-anchor-id="plomp-levelt-curves-slightly-adapted">Plomp-Levelt curves, slightly adapted</h2>
<p>(You can skip this discussion if you don’t know how Plomp-Levelt curves are originally constructed.)</p>
<p>The original Plomp-Levelt curves sum the dissonance over <em>consecutive</em> overtones on the resulting chord.</p>
<p>That’s a fine idea, but it’s a little weird when you take into account that overtones have different amplitudes. Say you have three overtones with frequencies <span><span id="ojs-element-id-1"></span></span> where the overtones are <span><span id="ojs-element-id-2"></span>.</span> Should that mean you don’t take the dissonances between the outer overtones into account? It seems better to me to take the sum of <em>all</em> pairs of overtones scaled by the product of the respective amplitudes.</p>
<p>This has the feature of making a “pure” tone have non-zero dissonance. That might be strange, but I think it’s fine. If you designed a nonharmonic instrument with its first overtone being inside the critical bandwidth, then <em>every note, by itself would sound rough and dissonant</em>. That’s the real lesson of the Plomp-Levelt experiments.</p>
<p>The way to reconcile these two notions is through generalized inner products. TBF.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" data-startfrom="250" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 249;"><span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plompLevelt</span>(baseFreq<span class="op">,</span> overtones<span class="op">,</span> high <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> step <span class="op">=</span> baseFreq <span class="op">/</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> low <span class="op">=</span> baseFreq <span class="op">*</span> <span class="fl">0.9</span><span class="op">;</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (high <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> baseFreq <span class="op">*</span> <span class="fl">2.1</span><span class="op">;</span></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> baseFreq <span class="op">*</span> high<span class="op">;</span></span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(low<span class="op">,</span> high<span class="op">,</span> step)<span class="op">;</span></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> baseTone <span class="op">=</span> <span class="fu">makeCompoundTone</span>(baseFreq<span class="op">,</span> overtones)<span class="op">;</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> y <span class="op">=</span> x<span class="op">.</span><span class="fu">map</span>(v <span class="kw">=&gt;</span> {</span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t1 <span class="op">=</span> baseTone<span class="op">,</span> t2 <span class="op">=</span> <span class="fu">makeCompoundTone</span>(v<span class="op">,</span> overtones)<span class="op">;</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> v1 <span class="op">=</span> <span class="fu">totalDissonance</span>(t1<span class="op">,</span> t1)<span class="op">,</span></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>      v2 <span class="op">=</span> <span class="fu">totalDissonance</span>(t1<span class="op">,</span> t2)<span class="op">,</span></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>      v3 <span class="op">=</span> <span class="fu">totalDissonance</span>(t2<span class="op">,</span> t2)<span class="op">;</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> v<span class="op">,</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> <span class="dv">2</span> <span class="op">*</span> v2 <span class="op">-</span> v1 <span class="op">-</span> v3</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">sizedPlot</span>({</span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Frequency"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [low<span class="op">,</span> high]<span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span> }<span class="op">,</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Dissonance"</span> }<span class="op">,</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [ Plot<span class="op">.</span><span class="fu">line</span>(y<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span>}) ]</span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-14" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" data-startfrom="281" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 280;"><span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeClarinetTone</span>(count<span class="op">,</span> decay)</span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a>  <span class="co">// clarinets (and other closed-tube wind instruments) only have odd harmonics!</span></span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a>  <span class="co">// this is very simplified model.</span></span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span> <span class="op">*</span> count<span class="op">,</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> ({ <span class="dt">tone</span><span class="op">:</span> c<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(decay<span class="op">,</span> c<span class="op">-</span><span class="dv">1</span>)}))<span class="op">;</span></span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-15" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" data-startfrom="290" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 289;"><span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>clarinetData <span class="op">=</span>[{<span class="dt">tone</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.75</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.5</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.14</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.5</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.12</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">13</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.17</span>}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-16" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" data-startfrom="294" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 293;"><span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeHarmonicTone</span>(count<span class="op">,</span> decay)</span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="dv">1</span><span class="op">,</span> count <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> ({ <span class="dt">tone</span><span class="op">:</span> c<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(decay<span class="op">,</span> c<span class="op">-</span><span class="dv">1</span>)}))<span class="op">;</span></span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-17" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" data-startfrom="301" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 300;"><span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> <span class="fu">makeHarmonicTone</span>(toneCount<span class="op">,</span> decay))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-18" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb19" data-startfrom="306" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 305;"><span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a>viewof toneCount <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span> { <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Overtone count"</span>} )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-19" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb20" data-startfrom="311" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 310;"><span id="cb20-311"><a href="#cb20-311" aria-hidden="true" tabindex="-1"></a>viewof decay <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> { <span class="dt">step</span><span class="op">:</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fl">0.9</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Overtone decay"</span>} )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-20" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" data-startfrom="315" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 314;"><span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">440</span><span class="op">,</span> <span class="fu">makeClarinetTone</span>(toneCount<span class="op">,</span> <span class="fl">0.9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-21" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" data-startfrom="319" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 318;"><span id="cb22-319"><a href="#cb22-319" aria-hidden="true" tabindex="-1"></a><span class="fu">makeClarinetTone</span>(<span class="dv">5</span><span class="op">,</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-22" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" data-startfrom="323" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 322;"><span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a><span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="fl">0.9</span><span class="op">,</span> <span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-23" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" data-startfrom="327" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 326;"><span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> [{<span class="dt">tone</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="fl">2.75</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="fl">5.4</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="fl">8.9</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-24" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" data-startfrom="331" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 330;"><span id="cb25-331"><a href="#cb25-331" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> <span class="fu">makeHarmonicTone</span>(<span class="dv">7</span><span class="op">,</span> <span class="fl">0.9</span>)<span class="op">,</span> <span class="fl">3.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-25" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" data-startfrom="335" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 334;"><span id="cb26-335"><a href="#cb26-335" aria-hidden="true" tabindex="-1"></a><span class="fu">totalDissonance</span>(<span class="fu">makeCompoundTone</span>(<span class="dv">1000</span><span class="op">,</span> clarinetData)<span class="op">,</span> <span class="fu">makeCompoundTone</span>(<span class="dv">1000</span> <span class="op">*</span> (<span class="dv">4</span><span class="op">/</span><span class="dv">3</span>)<span class="op">,</span> clarinetData))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-26" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" data-startfrom="340" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 339;"><span id="cb27-340"><a href="#cb27-340" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { sizePlot } <span class="im">from</span> <span class="st">"/src/cscheid/cscheid/observable.js"</span><span class="op">;</span></span>
<span id="cb27-341"><a href="#cb27-341" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sizedPlot</span>(<span class="op">...</span>args) {</span>
<span id="cb27-342"><a href="#cb27-342" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>(<span class="op">...</span>args)<span class="op">;</span></span>
<span id="cb27-343"><a href="#cb27-343" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">sizePlot</span>(result)<span class="op">;</span></span>
<span id="cb27-344"><a href="#cb27-344" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-27-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-27-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>


<!-- -->

<script type="ojs-module-contents">
{"contents":[
  {"methodName":"interpret","inline":"true","source":"htl.html`<span>${tex\\`x, x+\\epsilon, x+2\\epsilon\\`}</span>`", "cellName":"ojs-element-id-1"}
,
  {"methodName":"interpret","inline":"true","source":"htl.html`<span>${tex\\`1, 0.0001, 1\\`}</span>`", "cellName":"ojs-element-id-2"}
]}
</script>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-plomp1965tonal" class="csl-entry" role="doc-biblioentry">
Plomp, Reinier, and Willem Johannes Maria Levelt. 1965. <span>“Tonal Consonance and Critical Bandwidth.”</span> <em>The Journal of the Acoustical Society of America</em> 38 (4): 548–60.
</div>
<div id="ref-sethares2005tuning" class="csl-entry" role="doc-biblioentry">
Sethares, William A. 2005. <em>Tuning, Timbre, Spectrum, Scale</em>. Springer Science &amp; Business Media.
</div>
</div></section></div></main> <!-- /main -->
<script type="ojs-module-contents">
{"contents":[{"methodName":"interpret","cellName":"ojs-cell-1","inline":false,"source":"sizedPlot({\n  x: { label: \"Frequency\", type: \"log\", domain: [100, 10000] },\n  y: { label: \"Critical Bandwidth\", type: \"log\", domain: [50, 1000] },\n  marks: [ Plot.line(crit, {x: \"x\", y: \"y\"}), \n         // Plot.line(wholeTone, {x: \"x\", y: \"y\"}) \n         ]\n})\n"},{"methodName":"interpret","cellName":"ojs-cell-2","inline":false,"source":"sizedPlot({\n  x: {\n    label: \"Fraction of critical bandwidth →\"\n  },\n  y: {\n    label: \"↑ Dissonance\",\n    grid: true\n  },\n\n  marks: [\n    Plot.line(diss, {x: \"x\", y: \"y\"}),\n  ]\n})\n"},{"methodName":"interpret","cellName":"ojs-cell-3","inline":false,"source":"{\n  const w = 400;\n  const h = 400;\n  const steps = 400;\n  const minFreq = 100, maxFreq = 800;\n\n  const context = DOM.context2d(w, h);\n\n  // I'm sure there's a better way to do this.\n  const freq = d3.scaleLinear().range([Math.log(minFreq), Math.log(maxFreq)]).domain([0, steps]);\n  const x = d3.scaleLinear().domain([0, steps]).range([40, 360]);\n  const y = d3.scaleLinear().domain([0, steps]).range([370, 30]);\n  const color = d3.scaleLinear().domain([0, 1]).range([\"white\", \"red\"]);\n  \n  for (const xi of d3.range(steps)) {\n    for (const yi of d3.range(steps)) {\n      debugger;\n      const xf = Math.exp(freq(xi));\n      const yf = Math.exp(freq(yi));\n      const left = x(xi), top = y(yi + 1), right = x(xi + 1), bottom = y(yi);\n      const dis = totalDissonance([{tone: xf, amplitude: 1}], [{tone: yf, amplitude: 1}]);\n      context.fillStyle = color(dis);\n      context.fillRect(left, top, Math.round(right - left)+1, Math.abs(Math.round(top - bottom))+1);\n    }\n  }\n  const div = html`<div position=\"absolute\" width=\"400\" height=\"400\" style=\"max-height: 400px\"></div>`;\n  div.appendChild(context.canvas);\n  const svg = Plot.plot({\n    width: 400,\n    height: 400,\n    x: { type: \"log\", domain: [minFreq, maxFreq] },\n    y: { type: \"log\", domain: [minFreq, maxFreq] },\n    marks: [\n      Plot.line([{x: 440, y: minFreq}, {x: 440, y: maxFreq}], { x: \"x\", y: \"y\" })\n    ]\n  });\n  const svgStyle = svg.querySelector(\"svg style\");\n  svgStyle.innerHTML = svgStyle.innerHTML.replace(\"background: white;\", \"\");\n  svg.style.position = \"relative\";\n  svg.style.top = \"-405px\"; // 40_5_?! shrug\n  div.appendChild(svg);\n  return div;\n  // context.canvas;\n  // return context.canvas;\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-4","inline":false,"source":"plompLevelt(842, makeHarmonicTone(6, 0.75))\n"},{"methodName":"interpret","cellName":"ojs-cell-5","inline":false,"source":"plompLevelt(1000, clarinetData, 4.1)\n"},{"methodName":"interpret","cellName":"ojs-cell-6","inline":false,"source":"xLog = d3.range(1, 150).map(x => Math.pow(2, x/4))\n"},{"methodName":"interpret","cellName":"ojs-cell-7","inline":false,"source":"function dissonance(critBandwidthFraction)\n{\n  const x = critBandwidthFraction;\n  const t = 4 * Math.abs(x);\n  return t * Math.exp(1 - t);\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-8","inline":false,"source":"wholeTone = xLog.map(x => ({x, y: x * (Math.pow(2, 2/12) - 1)}))\n"},{"methodName":"interpret","cellName":"ojs-cell-9","inline":false,"source":"diss = d3.range(-2, 2, 0.01).map(x => ({ x, y: dissonance(x) }))\n"},{"methodName":"interpret","cellName":"ojs-cell-10","inline":false,"source":"// empirically reproducing the curve from Figure 3.4 in Sethares's Tuning, Timbre, Spectrum, Scale\nfunction criticalBandwidth(frequency)\n{\n  const x = frequency;\n  \n  const wholeTone = Math.pow(2, 2/12) - 1; // assume equal temperament for simplicity\n  const start = 100;\n  const xp = x - start;\n  const ramp = 500;\n  return start + xp * xp * wholeTone / (xp + ramp);\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-11","inline":false,"source":"crit = xLog.map(x => ({x, y: criticalBandwidth(x)}))\n"},{"methodName":"interpret","cellName":"ojs-cell-12","inline":false,"source":"function makeCompoundTone(baseFreq, overtones)\n{\n  return overtones.map(({ tone, amplitude }) => ({ tone: baseFreq * tone, amplitude }));\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-13","inline":false,"source":"function totalDissonance(tone1, tone2)\n{\n  let result = 0;\n  for (const { tone: ot1, amplitude: a1 } of tone1) {\n    for (const { tone: ot2, amplitude: a2 } of tone2) {\n      const low = Math.min(ot1, ot2), high = Math.max(ot1, ot2);\n      const c = criticalBandwidth(low);\n      result += dissonance((high - low) / (0.5 * c)) * a1 * a2;\n    }\n  }\n  return result;\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-14","inline":false,"source":"function plompLevelt(baseFreq, overtones, high = 0)\n{\n  const step = baseFreq / 300;\n  const low = baseFreq * 0.9;\n  if (high === 0) {\n    high = baseFreq * 2.1;\n  } else {\n    high = baseFreq * high;\n  }\n    \n  const x = d3.range(low, high, step);\n  const baseTone = makeCompoundTone(baseFreq, overtones);\n  const y = x.map(v => {\n    const t1 = baseTone, t2 = makeCompoundTone(v, overtones);\n    const v1 = totalDissonance(t1, t1),\n      v2 = totalDissonance(t1, t2),\n      v3 = totalDissonance(t2, t2);\n    return {\n      x: v,\n      y: 2 * v2 - v1 - v3\n    };\n  });\n  return sizedPlot({\n    x: { label: \"Frequency\", domain: [low, high], type: \"log\" },\n    y: { label: \"Dissonance\" },\n    marks: [ Plot.line(y, {x: \"x\", y: \"y\"}) ]\n  });\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-15","inline":false,"source":"function makeClarinetTone(count, decay)\n{\n  // clarinets (and other closed-tube wind instruments) only have odd harmonics!\n  // this is very simplified model.\n  return d3.range(1, 2 * count, 2).map(c => ({ tone: c, amplitude: Math.pow(decay, c-1)}));\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-16","inline":false,"source":"clarinetData =[{tone: 1, amplitude: 1}, {tone: 3, amplitude: 0.75}, {tone: 5, amplitude: 0.5}, {tone: 7, amplitude: 0.14}, {tone: 9, amplitude: 0.5}, {tone: 11, amplitude: 0.12}, {tone: 13, amplitude: 0.17}]\n"},{"methodName":"interpret","cellName":"ojs-cell-17","inline":false,"source":"function makeHarmonicTone(count, decay)\n{\n  return d3.range(1, count + 1).map(c => ({ tone: c, amplitude: Math.pow(decay, c-1)}));\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-18","inline":false,"source":"plompLevelt(1000, makeHarmonicTone(toneCount, decay))\n"},{"methodName":"interpret","cellName":"ojs-cell-19","inline":false,"source":"viewof toneCount = Inputs.range([1, 10], { step: 1, value: 3, label: \"Overtone count\"} )\n"},{"methodName":"interpret","cellName":"ojs-cell-20","inline":false,"source":"viewof decay = Inputs.range([0, 1], { step: 0.01, value: 0.9, label: \"Overtone decay\"} )\n"},{"methodName":"interpret","cellName":"ojs-cell-21","inline":false,"source":"plompLevelt(440, makeClarinetTone(toneCount, 0.9))\n"},{"methodName":"interpret","cellName":"ojs-cell-22","inline":false,"source":"makeClarinetTone(5, 0.9)\n"},{"methodName":"interpret","cellName":"ojs-cell-23","inline":false,"source":"Math.pow(0.9, -3)\n"},{"methodName":"interpret","cellName":"ojs-cell-24","inline":false,"source":"plompLevelt(1000, [{tone: 1, amplitude: 1}, {tone: 2.75, amplitude: 1}, {tone: 5.4, amplitude: 1}, {tone: 8.9, amplitude: 1}])\n"},{"methodName":"interpret","cellName":"ojs-cell-25","inline":false,"source":"plompLevelt(1000, makeHarmonicTone(7, 0.9), 3.1)\n"},{"methodName":"interpret","cellName":"ojs-cell-26","inline":false,"source":"totalDissonance(makeCompoundTone(1000, clarinetData), makeCompoundTone(1000 * (4/3), clarinetData))\n"},{"methodName":"interpret","cellName":"ojs-cell-27","inline":false,"source":"import { sizePlot } from \"/src/cscheid/cscheid/observable.js\";\nfunction sizedPlot(...args) {\n  const result = Plot.plot(...args);\n  return sizePlot(result);\n}\n"},{"methodName":"interpretQuiet","source":"shinyInput('toneCount')"},{"methodName":"interpretQuiet","source":"shinyInput('decay')"}]}
</script>
<script type="module">
window._ojs.paths.runtimeToDoc = "../../explainers/music";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Consonance and Dissonance"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - music.bib</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2022-06-13"</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>I recently learned that there's now a really good theory for why some musical intervals sound consonant ("nice"), and some sound dissonant ("rough", "out of tune"). This theory explains a lot of music, is backed by good experiments, is simple enough to explain in a single article, and was only figured out about 60 years ago.</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>Incredibly, this theory _also_ explains both why Pythagoras thought music had to do with simple fractions, why western music likes 12-tone scales so much, and why _other_ musical cultures choose other scales!</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>I'm talking about Plomp-Levelt curves <span class="co">[</span><span class="ot">@plomp1965tonal</span><span class="co">]</span>.</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## On terminology</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>In this article I'm using **consonance** to mean the perceptual notion: does this particular sound feel "smooth" or "rough"? Other definitions are also useful <span class="co">[</span><span class="ot">see @sethares2005tuning, chap. 3</span><span class="co">]</span>, especially for writing music within a particular culture! But I'm interested in the "perceptual" notion because, for example, it will eventually let us say interesting things about the other notions.</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Consonance and dissonance in "pure" sounds</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>In math, there's a famous way to decompose (or "analyze", in signal-processingese) complicated sounds into simple sounds: that's "Fourier analysis". Sounds are waves, and you can think of complicated sounds as a sum of simple waves. Then, if we understand what happens with simple sounds, we use this understanding as a building block to understand what happens with complex sounds.</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>The simplest wave is a sine curve with a given frequency and phase. But: is this math relevant to our how we _hear_ sounds?</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>It's an incredible biological fact about your ears that yes, ears do Fourier analysis! Specifically, your ear has a part called a _basilar membrane_, and it decomposes a sound into frequencies. Specifically, the basilar membrane makes it so different frequencies are sent to different positions in your cochlea.</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="fu">### Critical bandwidth</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>However, the basilar membrane is not perfect, and nearby frequencies bleed into one another. For each position in the cochlea, there is a range of nearby frequencies that activate it: some more strongly, some less so. The "size" of this region is called the "critical bandwidth", and it looks like this:</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sizedPlot</span>({</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">x</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Frequency"</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [<span class="dv">100</span><span class="op">,</span> <span class="dv">10000</span>] }<span class="op">,</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Critical Bandwidth"</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [<span class="dv">50</span><span class="op">,</span> <span class="dv">1000</span>] }<span class="op">,</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [ Plot<span class="op">.</span><span class="fu">line</span>(crit<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span>})<span class="op">,</span> </span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>         <span class="co">// Plot.line(wholeTone, {x: "x", y: "y"}) </span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>         ]</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="vs">Here's how you read this plot. The part of the cochlea that receives 100 Hz (Hz, "Hertz" is the frequency of "one per second". The higher the number, the faster the wave vibrates) also is activated by frequencies from 50 Hz to 150 Hz (100Hz is the "width" of the "band" it perceives, the "bandwidth"). At 1KHz, the bandwidth is closer to 150Hz, and at 3KHz and higher, it becomes around 12% of the base frequency.</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="vs">## Measuring consonance and dissonance of simple waves</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="vs">The breakthrough experiment that Plomp and Levelt did in 1965 was to ask people, in a controlled environment, whether pairs of sine waves sounded consonant or dissonant. They tried a number of different base frequencies and intervals (differences between the frequencies). They found that sine waves that are very close to one another sound consonant. So do sound waves that are very apart from one another. But two sine waves that are _kind of close_ to each other sound rough. And this distance tends to match the critical bandwidth along the basilar membrane! So, for pure sine waves, the curve looks like this.</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="fu">sizedPlot</span>({</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Fraction of critical bandwidth →"</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"↑ Dissonance"</span><span class="op">,</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">line</span>(diss<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span>})<span class="op">,</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="vs">A different way to think about this is to consider a two-dimensional plot of frequencies against frequencies, where color indicates</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="vs">whether a pair of sine waves will sound rough or in-tune:</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> w <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> h <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> steps <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> minFreq <span class="op">=</span> <span class="dv">100</span><span class="op">,</span> maxFreq <span class="op">=</span> <span class="dv">800</span><span class="op">;</span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> context <span class="op">=</span> DOM<span class="op">.</span><span class="fu">context2d</span>(w<span class="op">,</span> h)<span class="op">;</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">// I'm sure there's a better way to do this.</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> freq <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">range</span>([<span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>(minFreq)<span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>(maxFreq)])<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> steps])<span class="op">;</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> steps])<span class="op">.</span><span class="fu">range</span>([<span class="dv">40</span><span class="op">,</span> <span class="dv">360</span>])<span class="op">;</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> steps])<span class="op">.</span><span class="fu">range</span>([<span class="dv">370</span><span class="op">,</span> <span class="dv">30</span>])<span class="op">;</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([<span class="st">"white"</span><span class="op">,</span> <span class="st">"red"</span>])<span class="op">;</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> xi <span class="kw">of</span> d3<span class="op">.</span><span class="fu">range</span>(steps)) {</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> yi <span class="kw">of</span> d3<span class="op">.</span><span class="fu">range</span>(steps)) {</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>      <span class="cf">debugger</span><span class="op">;</span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> xf <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(<span class="fu">freq</span>(xi))<span class="op">;</span></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> yf <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(<span class="fu">freq</span>(yi))<span class="op">;</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> left <span class="op">=</span> <span class="fu">x</span>(xi)<span class="op">,</span> top <span class="op">=</span> <span class="fu">y</span>(yi <span class="op">+</span> <span class="dv">1</span>)<span class="op">,</span> right <span class="op">=</span> <span class="fu">x</span>(xi <span class="op">+</span> <span class="dv">1</span>)<span class="op">,</span> bottom <span class="op">=</span> <span class="fu">y</span>(yi)<span class="op">;</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> dis <span class="op">=</span> <span class="fu">totalDissonance</span>([{<span class="dt">tone</span><span class="op">:</span> xf<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}]<span class="op">,</span> [{<span class="dt">tone</span><span class="op">:</span> yf<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}])<span class="op">;</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span><span class="at">fillStyle</span> <span class="op">=</span> <span class="fu">color</span>(dis)<span class="op">;</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span><span class="fu">fillRect</span>(left<span class="op">,</span> top<span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(right <span class="op">-</span> left)<span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(top <span class="op">-</span> bottom))<span class="op">+</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> div <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div position="absolute" width="400" height="400" style="max-height: 400px"&gt;&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="fu">appendChild</span>(context<span class="op">.</span><span class="at">canvas</span>)<span class="op">;</span></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [minFreq<span class="op">,</span> maxFreq] }<span class="op">,</span></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [minFreq<span class="op">,</span> maxFreq] }<span class="op">,</span></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">line</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">440</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> minFreq}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="dv">440</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> maxFreq}]<span class="op">,</span> { <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span> })</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svgStyle <span class="op">=</span> svg<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"svg style"</span>)<span class="op">;</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>  svgStyle<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> svgStyle<span class="op">.</span><span class="at">innerHTML</span><span class="op">.</span><span class="fu">replace</span>(<span class="st">"background: white;"</span><span class="op">,</span> <span class="st">""</span>)<span class="op">;</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">position</span> <span class="op">=</span> <span class="st">"relative"</span><span class="op">;</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">top</span> <span class="op">=</span> <span class="st">"-405px"</span><span class="op">;</span> <span class="co">// 40_5_?! shrug</span></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="fu">appendChild</span>(svg)<span class="op">;</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> div<span class="op">;</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>  <span class="co">// context.canvas;</span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>  <span class="co">// return context.canvas;</span></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="vs">## "Cool trick. But consonance and dissonance are about music!"</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a><span class="vs">That's exactly right. And music is made with musical instruments. So we need to understand how sound comes out of musical instruments.</span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a><span class="vs">When you pluck a guitar string, you hear a specific pitch. The bottom string in a guitar is often tuned to "E2", which is associated with the frequency of 82.4Hz. But that's not the only frequency the guitar string sound contains. Guitar strings are "harmonic". This means that when the lowest frequency they sound is X, they also make a sound at _positive integer multiples_ of that frequency. They make sounds at 2X the frequency, 3X, 4X, and so on. You're so used to hearing guitar sounds (and "harmonic instruments" more generally, _especially_ if you were raised in Western Europe or North American musical cultures. More on that later), that you don't realize this.</span></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a><span class="vs">The practical consequence is that the sound you thought was simple is actually fairly complicated. But, because we have Fourier analysis as a tool (and because miraculously your ear does Fourier analysis too!) then Fourier analysis can help us decompose complex sounds. So, to study the consonance or dissonance of guitar sounds, we don't compare one pure wave to another. Instead, we compare the sum of the frequencies made by one string to the sum of the frequencies made by the other. Specifically, we add the sounds of the two strings together. Then, for every pair of resulting frequencies, we compute the dissonance using the formula from the charts above. The "total dissonance" is just the sum of the dissonances for every pair.</span></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a><span class="vs">Here is the dissonance curve for a simulated guitar sound of E3 (the E you sound with the fourth string of your guitar on the second fret).</span></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">842</span><span class="op">,</span> <span class="fu">makeHarmonicTone</span>(<span class="dv">6</span><span class="op">,</span> <span class="fl">0.75</span>))</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a><span class="vs">The base frequency for E3 is 842 Hz. If you're a musician, you'll notice right away that E4, an octave away at 1684Hz, sounds consonant. That's really cool, and it's actually not as obvious as it appears. Although guitars have consonant octaves, other instruments don't necessarily! If you're a musician, you might be surprised to know that (for example), pure sine waves a minor ninth away from one another don't sound dissonant, while they definitely do in the guitar (as you can also see in the chart by looking at 1784Hz).</span></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="vs">## There's no consonance without timbre</span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a><span class="vs">This is both a simple idea but also very deep: perceptually speaking, whether two notes sound consonant or dissonant depends on the "timbre" of the instrument that played the note.</span></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a><span class="vs">The "timbre" of an instrument is a hard thing to pin down, but we usually use the word to mean the difference between the sound of a piano's C4 and a clarinet's C4. In this simplified setting here, we will use timbre to mean "the set of additional waves produced by an instrument, together with the amplitude of each of those waves". If you've read some of the literature, you might have come across the phrase "overtone series", a more specific term for this aspect of timbre.</span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a><span class="vs">The valleys in the curve above indicate intervals that sound particularly consonant. So if you're looking to invent a system to play notes that tend to sound nice together, you will naturally end up with something that makes you choose those valleys. For "harmonic instruments" (instruments that produce harmonic overtones), those valleys correspond to many of the notes in the 12-tone scale, specifically under [just intonation](https://en.wikipedia.org/wiki/Just_intonation). So now we have a theory, math, and experiments that show how the design of musical scales is intimately connected to the way in the instruments generate sounds.</span></span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a><span class="vs">## Clarinet, and other timbres</span></span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a><span class="vs">This theory predicts a number of surprising things. For example, although wind instruments are harmonic, the overtone series of some wind instruments skips many of the harmonics. Specifically, wind instruments with closed tubes have _cancelling waves_ (because the wave bounces back at the end of the tube). As a result, they only emit overtones with **odd** integer multiples of the frequency. </span></span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a><span class="vs">To begin with, this makes them sound different from open-tube wind instruments. A clarinet is a closed-tube wind instrument, and so it sounds markedly different from a saxophone (which is open-tube and has even harmonic overtones). The same applies to the sound difference between flutes (open-tube) and pan flutes (closed-tube).</span></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a><span class="vs">But in addition to _sounding_ different, clarinets also prefer very different intervals to pianos (that part was personally surprising to me.) Here's the Plomp-Levelt curves for the clarinet, based on the overtones obtained by [Bryan Suits](https://pages.mtu.edu/~suits/clarinet.html).</span></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> clarinetData<span class="op">,</span> <span class="fl">4.1</span>)</span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="vs">In this chart, I'm showing frequencies from 1KHz to 4KHz, so _two_ octaves up. The results here are, if you'll forgive me, _wild_. This chart predicts that clarinet intervals sound more consonant at the _twelfth_ note of the traditional western diatonic scale than at the _octave itself_. There's other wild features too, such as the absence of an especially dissonant major seventh or ninth! Working from the theory, this all happens because the clarinet lacks the second harmonic (which is an octave up from the base). The second harmonic from the low note, then, is not there to clash with the base frequency of the high ninth note. </span></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a><span class="vs">I honestly didn't believe this at first. But then I wrote a simple synthesizer for clarinet sounds:</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a><span class="vs">- [Piano sounds](https://cscheid.net/static/synth/piano.mp3), fifth - **octave** - twelfth - **fifteenth**</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a><span class="vs">- [Clarinet sounds](https://cscheid.net/static/synth/clarinet.mp3), fifth - octave - **twelfth** - fifteenth</span></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="vs">I marked in bold what, to my ears, are the most consonant intervals in the sequences above. It's not a subtle effect either!</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a><span class="vs">So, it seems clear to me that a culture that only played closed-tube harmonic instruments could easily end up with weird scales that revolved around twelfth intervals being the "pseudo-octave". It just sounds better than the octave! That's bananas. </span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a><span class="vs">## Beyond harmonic instruments</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a><span class="vs">More shockingly, this is only the beginning of this story. We don't need to come up with imaginary cultures. Non-western cultures play instruments that want different scales, and that's why they use them!</span></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a><span class="vs">TBF: Thai xylophones, gamelans</span></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a><span class="vs"># Appendix: code</span></span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>xLog <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">150</span>)<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> x<span class="op">/</span><span class="dv">4</span>))</span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dissonance</span>(critBandwidthFraction)</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> critBandwidthFraction<span class="op">;</span></span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> t <span class="op">=</span> <span class="dv">4</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(x)<span class="op">;</span></span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> t <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(<span class="dv">1</span> <span class="op">-</span> t)<span class="op">;</span></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>wholeTone <span class="op">=</span> xLog<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> ({x<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> x <span class="op">*</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span>)}))</span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>diss <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.01</span>)<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> ({ x<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">dissonance</span>(x) }))</span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a><span class="co">// empirically reproducing the curve from Figure 3.4 in Sethares's Tuning, Timbre, Spectrum, Scale</span></span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">criticalBandwidth</span>(frequency)</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> frequency<span class="op">;</span></span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> wholeTone <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// assume equal temperament for simplicity</span></span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> start <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> xp <span class="op">=</span> x <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ramp <span class="op">=</span> <span class="dv">500</span><span class="op">;</span></span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> start <span class="op">+</span> xp <span class="op">*</span> xp <span class="op">*</span> wholeTone <span class="op">/</span> (xp <span class="op">+</span> ramp)<span class="op">;</span></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>crit <span class="op">=</span> xLog<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> ({x<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">criticalBandwidth</span>(x)}))</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a><span class="vs"># Compound Tones</span></span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeCompoundTone</span>(baseFreq<span class="op">,</span> overtones)</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> overtones<span class="op">.</span><span class="fu">map</span>(({ tone<span class="op">,</span> amplitude }) <span class="kw">=&gt;</span> ({ <span class="dt">tone</span><span class="op">:</span> baseFreq <span class="op">*</span> tone<span class="op">,</span> amplitude }))<span class="op">;</span></span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">totalDissonance</span>(tone1<span class="op">,</span> tone2)</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> result <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> { <span class="dt">tone</span><span class="op">:</span> ot1<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> a1 } <span class="kw">of</span> tone1) {</span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> { <span class="dt">tone</span><span class="op">:</span> ot2<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> a2 } <span class="kw">of</span> tone2) {</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> low <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(ot1<span class="op">,</span> ot2)<span class="op">,</span> high <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(ot1<span class="op">,</span> ot2)<span class="op">;</span></span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> c <span class="op">=</span> <span class="fu">criticalBandwidth</span>(low)<span class="op">;</span></span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>      result <span class="op">+=</span> <span class="fu">dissonance</span>((high <span class="op">-</span> low) <span class="op">/</span> (<span class="fl">0.5</span> <span class="op">*</span> c)) <span class="op">*</span> a1 <span class="op">*</span> a2<span class="op">;</span></span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a><span class="vs">## Plomp-Levelt curves, slightly adapted</span></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a><span class="vs">(You can skip this discussion if you don't know how Plomp-Levelt curves are originally constructed.)</span></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a><span class="vs">The original Plomp-Levelt curves sum the dissonance over _consecutive_ overtones on the resulting chord. </span></span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a><span class="vs">That's a fine idea, but it's a little weird when you take into account that overtones have different amplitudes. Say you have three overtones with frequencies </span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`x, x+</span><span class="sc">\e</span><span class="vs">psilon, x+2</span><span class="sc">\e</span><span class="vs">psilon`</span><span class="sc">}</span><span class="vs"> where the overtones are </span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`1, 0.0001, 1`</span><span class="sc">}</span><span class="vs">. Should that mean you don't take the dissonances between the outer overtones into account? It seems better to me to take the sum of _all_ pairs of overtones scaled by the product of the respective amplitudes.</span></span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a><span class="vs">This has the feature of making a "pure" tone have non-zero dissonance. That might be strange, but I think it's fine. If you designed a nonharmonic instrument with its first overtone being inside the critical bandwidth, then _every note, by itself would sound rough and dissonant_. That's the real lesson of the Plomp-Levelt experiments.</span></span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a><span class="vs">The way to reconcile these two notions is through generalized inner products. TBF.</span></span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plompLevelt</span>(baseFreq<span class="op">,</span> overtones<span class="op">,</span> high <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> step <span class="op">=</span> baseFreq <span class="op">/</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> low <span class="op">=</span> baseFreq <span class="op">*</span> <span class="fl">0.9</span><span class="op">;</span></span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (high <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> baseFreq <span class="op">*</span> <span class="fl">2.1</span><span class="op">;</span></span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> baseFreq <span class="op">*</span> high<span class="op">;</span></span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(low<span class="op">,</span> high<span class="op">,</span> step)<span class="op">;</span></span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> baseTone <span class="op">=</span> <span class="fu">makeCompoundTone</span>(baseFreq<span class="op">,</span> overtones)<span class="op">;</span></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> y <span class="op">=</span> x<span class="op">.</span><span class="fu">map</span>(v <span class="kw">=&gt;</span> {</span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t1 <span class="op">=</span> baseTone<span class="op">,</span> t2 <span class="op">=</span> <span class="fu">makeCompoundTone</span>(v<span class="op">,</span> overtones)<span class="op">;</span></span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> v1 <span class="op">=</span> <span class="fu">totalDissonance</span>(t1<span class="op">,</span> t1)<span class="op">,</span></span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a>      v2 <span class="op">=</span> <span class="fu">totalDissonance</span>(t1<span class="op">,</span> t2)<span class="op">,</span></span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a>      v3 <span class="op">=</span> <span class="fu">totalDissonance</span>(t2<span class="op">,</span> t2)<span class="op">;</span></span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> v<span class="op">,</span></span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> <span class="dv">2</span> <span class="op">*</span> v2 <span class="op">-</span> v1 <span class="op">-</span> v3</span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">sizedPlot</span>({</span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Frequency"</span><span class="op">,</span> <span class="dt">domain</span><span class="op">:</span> [low<span class="op">,</span> high]<span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"log"</span> }<span class="op">,</span></span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Dissonance"</span> }<span class="op">,</span></span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [ Plot<span class="op">.</span><span class="fu">line</span>(y<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span>}) ]</span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeClarinetTone</span>(count<span class="op">,</span> decay)</span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a>  <span class="co">// clarinets (and other closed-tube wind instruments) only have odd harmonics!</span></span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a>  <span class="co">// this is very simplified model.</span></span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span> <span class="op">*</span> count<span class="op">,</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> ({ <span class="dt">tone</span><span class="op">:</span> c<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(decay<span class="op">,</span> c<span class="op">-</span><span class="dv">1</span>)}))<span class="op">;</span></span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a>clarinetData <span class="op">=</span>[{<span class="dt">tone</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.75</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.5</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.14</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.5</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.12</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="dv">13</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="fl">0.17</span>}]</span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeHarmonicTone</span>(count<span class="op">,</span> decay)</span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> d3<span class="op">.</span><span class="fu">range</span>(<span class="dv">1</span><span class="op">,</span> count <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> ({ <span class="dt">tone</span><span class="op">:</span> c<span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(decay<span class="op">,</span> c<span class="op">-</span><span class="dv">1</span>)}))<span class="op">;</span></span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> <span class="fu">makeHarmonicTone</span>(toneCount<span class="op">,</span> decay))</span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a>viewof toneCount <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span> { <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Overtone count"</span>} )</span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a>viewof decay <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> { <span class="dt">step</span><span class="op">:</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fl">0.9</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Overtone decay"</span>} )</span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">440</span><span class="op">,</span> <span class="fu">makeClarinetTone</span>(toneCount<span class="op">,</span> <span class="fl">0.9</span>))</span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a><span class="fu">makeClarinetTone</span>(<span class="dv">5</span><span class="op">,</span> <span class="fl">0.9</span>)</span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a><span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="fl">0.9</span><span class="op">,</span> <span class="op">-</span><span class="dv">3</span>)</span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> [{<span class="dt">tone</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="fl">2.75</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="fl">5.4</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> {<span class="dt">tone</span><span class="op">:</span> <span class="fl">8.9</span><span class="op">,</span> <span class="dt">amplitude</span><span class="op">:</span> <span class="dv">1</span>}])</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a><span class="fu">plompLevelt</span>(<span class="dv">1000</span><span class="op">,</span> <span class="fu">makeHarmonicTone</span>(<span class="dv">7</span><span class="op">,</span> <span class="fl">0.9</span>)<span class="op">,</span> <span class="fl">3.1</span>)</span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a><span class="fu">totalDissonance</span>(<span class="fu">makeCompoundTone</span>(<span class="dv">1000</span><span class="op">,</span> clarinetData)<span class="op">,</span> <span class="fu">makeCompoundTone</span>(<span class="dv">1000</span> <span class="op">*</span> (<span class="dv">4</span><span class="op">/</span><span class="dv">3</span>)<span class="op">,</span> clarinetData))</span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { sizePlot } <span class="im">from</span> <span class="st">"/src/cscheid/cscheid/observable.js"</span><span class="op">;</span></span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sizedPlot</span>(<span class="op">...</span>args) {</span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>(<span class="op">...</span>args)<span class="op">;</span></span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">sizePlot</span>(result)<span class="op">;</span></span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>